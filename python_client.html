<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 90%;
            max-width: 1200px;
            background: #2d2d2d;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        .login-screen, .chat-screen {
            padding: 40px;
        }
        .login-screen {
            text-align: center;
        }
        .login-screen h1 {
            margin-bottom: 30px;
            color: #e0e0e0;
        }
        .login-screen input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 16px;
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        .login-screen input::placeholder {
            color: #888;
        }
        .login-screen button {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        .login-screen button:hover {
            background-color: #45a049;
        }
        .chat-screen {
            display: none;
            padding: 0;
        }
        .chat-header {
            padding: 20px;
            background-color: #4CAF50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header h2 {
            font-size: 20px;
        }
        .status {
            font-size: 14px;
            opacity: 0.9;
        }
        .main-content {
            display: flex;
            height: 600px;
        }
        .voice-panel {
            width: 300px;
            background-color: #242424;
            border-right: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
        }
        .voice-panel h3 {
            color: #e0e0e0;
            margin-bottom: 20px;
            font-size: 16px;
        }
        .voice-controls {
            margin-bottom: 20px;
        }
        .voice-button {
            width: 100%;
            padding: 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .voice-button:hover {
            background-color: #0b7dda;
        }
        .voice-button.active {
            background-color: #f44336;
        }
        .voice-button.active:hover {
            background-color: #da190b;
        }
        .screen-button {
            background-color: #9C27B0;
        }
        .screen-button:hover {
            background-color: #7B1FA2;
        }
        .screen-button.active {
            background-color: #f44336;
        }
        .voice-users {
            color: #e0e0e0;
            margin-bottom: 20px;
        }
        .voice-user {
            padding: 10px;
            background-color: #3a3a3a;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .voice-user.speaking {
            border: 2px solid #4CAF50;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .screen-shares {
            color: #e0e0e0;
        }
        .screen-share-item {
            padding: 10px;
            background-color: #3a3a3a;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .screen-share-item:hover {
            background-color: #4a4a4a;
        }
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #1f1f1f;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            background: #3a3a3a;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .message-sender {
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .message-content {
            color: #e0e0e0;
            word-wrap: break-word;
        }
        .message-time {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .input-area {
            padding: 20px;
            background-color: #2d2d2d;
            border-top: 1px solid #444;
            display: flex;
            gap: 10px;
        }
        .input-area input {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 14px;
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        .input-area input::placeholder {
            color: #888;
        }
        .input-area button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .input-area button:hover {
            background-color: #45a049;
        }
        .hidden {
            display: none;
        }
        .volume-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #666;
        }
        .volume-indicator.active {
            background-color: #4CAF50;
        }
        .screen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            padding: 20px;
        }
        .screen-modal.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .screen-modal video {
            max-width: 90%;
            max-height: 80%;
            border-radius: 8px;
        }
        .screen-modal-header {
            color: white;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .screen-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .screen-modal-close:hover {
            background-color: #da190b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <h1>Join Chat</h1>
            <input type="text" id="usernameInput" placeholder="Enter your username" maxlength="20">
            <button onclick="login()">Join</button>
        </div>

        <!-- Chat Screen -->
        <div class="chat-screen" id="chatScreen">
            <div class="chat-header">
                <h2>Chat Room</h2>
                <span class="status" id="status">Connecting...</span>
            </div>
            <div class="main-content">
                <!-- Voice Panel -->
                <div class="voice-panel">
                    <h3>Voice Chat</h3>
                    <div class="voice-controls">
                        <button class="voice-button" id="joinVoiceBtn" onclick="toggleVoiceChat()">üé§ Join Voice</button>
                        <button class="voice-button" id="muteBtn" onclick="toggleMute()" style="display:none;">üîá Mute</button>
                        <button class="voice-button screen-button" id="screenBtn" onclick="toggleScreenShare()">üñ•Ô∏è Share Screen</button>
                    </div>
                    <h3>In Voice (<span id="voiceCount">0</span>)</h3>
                    <div class="voice-users" id="voiceUsers">
                        <div style="color: #888; font-size: 14px;">No one in voice chat</div>
                    </div>
                    <h3>Screen Shares</h3>
                    <div class="screen-shares" id="screenShares">
                        <div style="color: #888; font-size: 14px;">No active screen shares</div>
                    </div>
                </div>

                <!-- Chat Panel -->
                <div class="chat-panel">
                    <div class="messages" id="messages"></div>
                    <div class="input-area">
                        <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen Share Modal -->
    <div class="screen-modal" id="screenModal">
        <button class="screen-modal-close" onclick="closeScreenModal()">Close</button>
        <div class="screen-modal-header" id="screenModalHeader">Screen Share</div>
        <video id="screenVideo" autoplay></video>
    </div>

    <script>
        let ws = null;
        let username = '';
        let inVoiceChat = false;
        let isMuted = false;
        let localStream = null;
        let audioContext = null;
        let voiceUsers = new Set();
        let screenStream = null;
        let isScreenSharing = false;
        let screenShares = new Map();

        function login() {
            const usernameInput = document.getElementById('usernameInput').value.trim();
            
            if (!usernameInput) {
                alert('Please enter a username');
                return;
            }
            
            username = usernameInput;
            
            // Hide login, show chat
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'block';
            
            // Connect to WebSocket
            connectWebSocket('wss://chatting-9qbc.onrender.com');
        }

        function connectWebSocket(serverAddress) {
            ws = new WebSocket(serverAddress);
            
            ws.onopen = () => {
                document.getElementById('status').textContent = 'Connected';
                // Send join notification
                ws.send(JSON.stringify({
                    type: 'system',
                    sender: 'System',
                    content: `${username} joined the chat`
                }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'voice_join') {
                    voiceUsers.add(data.sender);
                    updateVoiceUsers();
                } else if (data.type === 'voice_leave') {
                    voiceUsers.delete(data.sender);
                    updateVoiceUsers();
                } else if (data.type === 'voice_data') {
                    playAudioData(data.sender, data.content);
                } else if (data.type === 'screen_start') {
                    screenShares.set(data.sender, true);
                    updateScreenShares();
                } else if (data.type === 'screen_stop') {
                    screenShares.delete(data.sender);
                    updateScreenShares();
                } else if (data.type === 'screen_frame') {
                    handleScreenFrame(data.sender, data.content);
                } else if (data.type === 'text' || data.type === 'system') {
                    // Only display if it's not from us (server already filters, but double check)
                    if (data.sender !== username) {
                        displayMessage(data);
                    }
                }
            };
            
            ws.onclose = () => {
                document.getElementById('status').textContent = 'Disconnected';
                if (inVoiceChat) {
                    leaveVoiceChat();
                }
                if (isScreenSharing) {
                    stopScreenShare();
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('status').textContent = 'Connection Error';
            };
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }
            
            // Display your own message immediately
            displayMessage({
                type: 'text',
                sender: username,
                content: message,
                timestamp: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' })
            });
            
            // Then send to server (which broadcasts to others)
            ws.send(JSON.stringify({
                type: 'text',
                sender: username,
                content: message
            }));
            
            input.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function displayMessage(data) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = data.sender;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = data.content;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = data.timestamp || '';
            
            messageDiv.appendChild(senderDiv);
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timeDiv);
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function toggleVoiceChat() {
            if (!inVoiceChat) {
                await joinVoiceChat();
            } else {
                leaveVoiceChat();
            }
        }

        async function joinVoiceChat() {
            try {
                // Request microphone access
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                // Setup audio context for processing
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(localStream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                processor.onaudioprocess = (e) => {
                    if (!isMuted && ws && ws.readyState === WebSocket.OPEN) {
                        const audioData = e.inputBuffer.getChannelData(0);
                        // Convert to base64 for transmission
                        const dataArray = Array.from(audioData);
                        ws.send(JSON.stringify({
                            type: 'voice_data',
                            sender: username,
                            content: dataArray
                        }));
                    }
                };
                
                inVoiceChat = true;
                document.getElementById('joinVoiceBtn').textContent = 'üìû Leave Voice';
                document.getElementById('joinVoiceBtn').classList.add('active');
                document.getElementById('muteBtn').style.display = 'block';
                
                // Notify others
                ws.send(JSON.stringify({
                    type: 'voice_join',
                    sender: username
                }));
                
                voiceUsers.add(username);
                updateVoiceUsers();
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        function leaveVoiceChat() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            inVoiceChat = false;
            isMuted = false;
            document.getElementById('joinVoiceBtn').textContent = 'üé§ Join Voice';
            document.getElementById('joinVoiceBtn').classList.remove('active');
            document.getElementById('muteBtn').style.display = 'none';
            
            // Notify others
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'voice_leave',
                    sender: username
                }));
            }
            
            voiceUsers.delete(username);
            updateVoiceUsers();
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('muteBtn');
            if (isMuted) {
                btn.textContent = 'üîá Unmute';
                btn.style.backgroundColor = '#f44336';
            } else {
                btn.textContent = 'üîä Mute';
                btn.style.backgroundColor = '#2196F3';
            }
        }

        async function toggleScreenShare() {
            if (!isScreenSharing) {
                await startScreenShare();
            } else {
                stopScreenShare();
            }
        }

        async function startScreenShare() {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always"
                    },
                    audio: false
                });

                isScreenSharing = true;
                document.getElementById('screenBtn').textContent = 'üõë Stop Sharing';
                document.getElementById('screenBtn').classList.add('active');

                // Notify others
                ws.send(JSON.stringify({
                    type: 'screen_start',
                    sender: username
                }));

                screenShares.set(username, true);
                updateScreenShares();

                // Capture frames and send them
                const video = document.createElement('video');
                video.srcObject = screenStream;
                video.play();

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const sendFrame = () => {
                    if (!isScreenSharing) return;

                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);

                    // Compress and send frame
                    const frameData = canvas.toDataURL('image/jpeg', 0.5);
                    ws.send(JSON.stringify({
                        type: 'screen_frame',
                        sender: username,
                        content: frameData
                    }));

                    setTimeout(sendFrame, 100); // ~10 FPS
                };

                sendFrame();

                // Handle when user stops sharing via browser UI
                screenStream.getVideoTracks()[0].onended = () => {
                    stopScreenShare();
                };

            } catch (error) {
                console.error('Error sharing screen:', error);
                alert('Could not share screen. Please check permissions.');
            }
        }

        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            isScreenSharing = false;
            document.getElementById('screenBtn').textContent = 'üñ•Ô∏è Share Screen';
            document.getElementById('screenBtn').classList.remove('active');

            // Notify others
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'screen_stop',
                    sender: username
                }));
            }

            screenShares.delete(username);
            updateScreenShares();
        }

        function updateVoiceUsers() {
            const voiceUsersDiv = document.getElementById('voiceUsers');
            const countSpan = document.getElementById('voiceCount');
            
            countSpan.textContent = voiceUsers.size;
            
            if (voiceUsers.size === 0) {
                voiceUsersDiv.innerHTML = '<div style="color: #888; font-size: 14px;">No one in voice chat</div>';
                return;
            }
            
            voiceUsersDiv.innerHTML = '';
            voiceUsers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'voice-user';
                userDiv.innerHTML = `
                    <span>${user}</span>
                    <div class="volume-indicator" id="vol-${user}"></div>
                `;
                voiceUsersDiv.appendChild(userDiv);
            });
        }

        function updateScreenShares() {
            const screenSharesDiv = document.getElementById('screenShares');
            
            if (screenShares.size === 0) {
                screenSharesDiv.innerHTML = '<div style="color: #888; font-size: 14px;">No active screen shares</div>';
                return;
            }
            
            screenSharesDiv.innerHTML = '';
            screenShares.forEach((value, user) => {
                const shareDiv = document.createElement('div');
                shareDiv.className = 'screen-share-item';
                shareDiv.textContent = `${user}'s screen`;
                shareDiv.onclick = () => viewScreenShare(user);
                screenSharesDiv.appendChild(shareDiv);
            });
        }

        function viewScreenShare(user) {
            // Will show the screen in modal when frames arrive
            document.getElementById('screenModalHeader').textContent = `${user}'s Screen`;
            document.getElementById('screenModal').classList.add('active');
        }

        function closeScreenModal() {
            document.getElementById('screenModal').classList.remove('active');
        }

        function handleScreenFrame(sender, frameData) {
            // Store the latest frame for this user
            const video = document.getElementById('screenVideo');
            const modal = document.getElementById('screenModal');
            const header = document.getElementById('screenModalHeader');
            
            // If we're currently viewing this user's screen
            if (modal.classList.contains('active') && header.textContent === `${sender}'s Screen`) {
                video.src = frameData;
            }
        }

        function playAudioData(sender, audioData) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const buffer = audioContext.createBuffer(1, audioData.length, audioContext.sampleRate);
            const channelData = buffer.getChannelData(0);
            for (let i = 0; i < audioData.length; i++) {
                channelData[i] = audioData[i];
            }
            
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start();
            
            // Visual indicator
            const indicator = document.getElementById(`vol-${sender}`);
            if (indicator) {
                indicator.classList.add('active');
                setTimeout(() => indicator.classList.remove('active'), 100);
            }
        }
    </script>
</body>
</html>
