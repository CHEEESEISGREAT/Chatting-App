<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            background: #2d2d2d;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
        }
        .login-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #2d2d2d;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .login-box {
            background: #3a3a3a;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            min-width: 400px;
        }
        .login-box h1 {
            color: #e0e0e0;
            margin-bottom: 30px;
        }
        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 16px;
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        .login-box input::placeholder {
            color: #888;
        }
        .login-box button {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        .login-box button:hover {
            background-color: #45a049;
        }
        .guild-sidebar {
            width: 80px;
            background-color: #1f1f1f;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            gap: 10px;
        }
        .guild-icon {
            width: 50px;
            height: 50px;
            background-color: #3a3a3a;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: #e0e0e0;
            font-weight: bold;
            font-size: 18px;
        }
        .guild-icon:hover {
            background-color: #4CAF50;
            border-radius: 15px;
        }
        .guild-icon.active {
            background-color: #4CAF50;
            border-radius: 15px;
        }
        .guild-icon.add {
            background-color: #4CAF50;
            font-size: 24px;
        }
        .voice-panel {
            width: 250px;
            background-color: #242424;
            border-right: 1px solid #444;
            display: flex;
            flex-direction: column;
        }
        .guild-info {
            padding: 20px;
            border-bottom: 1px solid #444;
            color: #e0e0e0;
        }
        .guild-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .invite-code {
            font-size: 12px;
            color: #888;
            cursor: pointer;
        }
        .invite-code:hover {
            color: #4CAF50;
        }
        .voice-section {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        .voice-section h3 {
            color: #e0e0e0;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .voice-button {
            width: 100%;
            padding: 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .voice-button:hover {
            background-color: #0b7dda;
        }
        .voice-button.active {
            background-color: #f44336;
        }
        .screen-button {
            background-color: #9C27B0;
        }
        .screen-button:hover {
            background-color: #7B1FA2;
        }
        .voice-user {
            padding: 8px;
            background-color: #3a3a3a;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #e0e0e0;
        }
        .voice-user.speaking {
            border: 2px solid #4CAF50;
        }
        .volume-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #666;
        }
        .volume-indicator.active {
            background-color: #4CAF50;
        }
        .screen-share-item {
            padding: 8px;
            background-color: #3a3a3a;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            color: #e0e0e0;
        }
        .screen-share-item:hover {
            background-color: #4a4a4a;
        }
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 20px;
            background-color: #2d2d2d;
            color: white;
            border-bottom: 1px solid #444;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #1f1f1f;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            background: #3a3a3a;
            border-radius: 4px;
        }
        .message-sender {
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .message-content {
            color: #e0e0e0;
            word-wrap: break-word;
        }
        .message-time {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .input-area {
            padding: 20px;
            background-color: #2d2d2d;
            border-top: 1px solid #444;
            display: flex;
            gap: 10px;
        }
        .input-area input {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 14px;
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        .input-area button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 8px;
            min-width: 400px;
        }
        .modal-content h2 {
            color: #e0e0e0;
            margin-bottom: 20px;
        }
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        .modal-content button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .modal-close {
            background-color: #f44336 !important;
        }
        .screen-modal img {
            max-width: 90%;
            max-height: 80%;
            border-radius: 8px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>Join Chat</h1>
            <input type="text" id="usernameInput" placeholder="Enter your username" maxlength="20">
            <button onclick="login()">Join</button>
        </div>
    </div>

    <!-- Main App -->
    <div class="container" id="mainApp" style="display:none;">
        <!-- Guild Sidebar -->
        <div class="guild-sidebar" id="guildSidebar">
            <div class="guild-icon add" onclick="showGuildModal()">+</div>
        </div>

        <!-- Voice Panel -->
        <div class="voice-panel">
            <div class="guild-info">
                <div class="guild-name" id="guildName">Select a guild</div>
                <div class="invite-code" id="inviteCode" onclick="copyInvite()">Click to copy invite</div>
            </div>
            <div class="voice-section">
                <h3>Voice</h3>
                <button class="voice-button" id="joinVoiceBtn" onclick="toggleVoice()">üé§ Join Voice</button>
                <button class="voice-button" id="muteBtn" onclick="toggleMute()" style="display:none;">üîä Mute</button>
                <button class="voice-button screen-button" id="screenBtn" onclick="toggleScreen()">üñ•Ô∏è Share Screen</button>
                
                <h3>In Voice (<span id="voiceCount">0</span>)</h3>
                <div id="voiceUsers"></div>
                
                <h3>Screen Shares</h3>
                <div id="screenShares"></div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel">
            <div class="chat-header">
                <span id="status">Connected</span>
            </div>
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMessage()">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Guild Modal -->
    <div class="modal" id="guildModal">
        <div class="modal-content">
            <h2>Create or Join Guild</h2>
            <input type="text" id="guildNameInput" placeholder="Guild name">
            <button onclick="createGuild()">Create Guild</button>
            <hr style="margin: 20px 0; border-color: #444;">
            <input type="text" id="inviteCodeInput" placeholder="Invite code">
            <button onclick="joinGuild()">Join Guild</button>
            <button class="modal-close" onclick="closeGuildModal()">Close</button>
        </div>
    </div>

    <!-- Screen Share Modal -->
    <div class="modal screen-modal" id="screenModal">
        <button style="position:absolute;top:20px;right:20px;padding:10px 20px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;" onclick="closeScreenModal()">Close</button>
        <div style="color:white;margin-bottom:20px;font-size:20px;" id="screenModalHeader">Screen Share</div>
        <img id="screenImage">
    </div>

    <script>
        let ws = null;
        let username = '';
        let currentGuild = null;
        let guilds = [];
        let inVoice = false;
        let isMuted = false;
        let isScreenSharing = false;
        let mediaRecorder = null;
        let screenStream = null;
        let voiceUsers = [];
        let screenUsers = [];

        async function login() {
            username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('Enter a username');
                return;
            }

            ws = new WebSocket('wss://chatting-9qbc.onrender.com');
            
            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'auth', username }));
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
            };

            ws.onmessage = handleMessage;
            ws.onerror = (e) => console.error('WebSocket error:', e);
            ws.onclose = () => {
                document.getElementById('status').textContent = 'Disconnected';
                if (inVoice) toggleVoice();
                if (isScreenSharing) toggleScreen();
            };
        }

        function handleMessage(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === 'guild_list') {
                guilds = data.guilds;
                renderGuilds();
            } else if (data.type === 'guild_created' || data.type === 'guild_joined') {
                guilds.push(data.guild);
                renderGuilds();
                switchGuild(data.guild.id);
                closeGuildModal();
            } else if (data.type === 'message_history') {
                document.getElementById('messages').innerHTML = '';
                data.messages.forEach(msg => displayMessage(msg, false));
            } else if (data.type === 'voice_state') {
                voiceUsers = data.users;
                updateVoiceUsers();
            } else if (data.type === 'screen_state') {
                screenUsers = data.users;
                updateScreenUsers();
            } else if (data.type === 'text') {
                displayMessage(data, false);
            } else if (data.type === 'voice_join') {
                if (!voiceUsers.includes(data.sender)) {
                    voiceUsers.push(data.sender);
                    updateVoiceUsers();
                }
            } else if (data.type === 'voice_leave') {
                voiceUsers = voiceUsers.filter(u => u !== data.sender);
                updateVoiceUsers();
            } else if (data.type === 'voice_data') {
                playAudio(data.sender, data.content);
            } else if (data.type === 'screen_start') {
                if (!screenUsers.includes(data.sender)) {
                    screenUsers.push(data.sender);
                    updateScreenUsers();
                }
            } else if (data.type === 'screen_stop') {
                screenUsers = screenUsers.filter(u => u !== data.sender);
                updateScreenUsers();
            } else if (data.type === 'screen_frame') {
                handleScreenFrame(data.sender, data.content);
            }
        }

        function renderGuilds() {
            const sidebar = document.getElementById('guildSidebar');
            const existing = sidebar.querySelectorAll('.guild-icon:not(.add)');
            existing.forEach(el => el.remove());

            guilds.forEach(guild => {
                const icon = document.createElement('div');
                icon.className = 'guild-icon';
                icon.textContent = guild.name[0].toUpperCase();
                icon.title = guild.name;
                icon.onclick = () => switchGuild(guild.id);
                if (currentGuild && currentGuild.id === guild.id) {
                    icon.classList.add('active');
                }
                sidebar.appendChild(icon);
            });
        }

        function switchGuild(guildId) {
            currentGuild = guilds.find(g => g.id === guildId);
            if (!currentGuild) return;

            document.getElementById('guildName').textContent = currentGuild.name;
            document.getElementById('inviteCode').textContent = `Invite: ${currentGuild.invite_code}`;
            document.getElementById('messages').innerHTML = '';
            
            ws.send(JSON.stringify({ type: 'switch_guild', guild_id: guildId }));
            renderGuilds();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content || !currentGuild) return;

            const msg = { type: 'text', sender: username, content };
            displayMessage(msg, true);
            ws.send(JSON.stringify(msg));
            input.value = '';
        }

        function displayMessage(data, isOwn) {
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `
                <div class="message-sender">${data.sender}</div>
                <div class="message-content">${data.content}</div>
                <div class="message-time">${data.timestamp || ''}</div>
            `;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 999999;
        }

        async function toggleVoice() {
            if (!inVoice) {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true, sampleRate: 48000 } 
                });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                mediaRecorder.ondataavailable = (e) => {
                    if (!isMuted && e.data.size > 0) {
                        const reader = new FileReader();
                        reader.onload = () => {
                            ws.send(JSON.stringify({ type: 'voice_data', sender: username, content: reader.result.split(',')[1] }));
                        };
                        reader.readAsDataURL(e.data);
                    }
                };
                mediaRecorder.start(20);
                inVoice = true;
                document.getElementById('joinVoiceBtn').textContent = 'üìû Leave Voice';
                document.getElementById('joinVoiceBtn').classList.add('active');
                document.getElementById('muteBtn').style.display = 'block';
                ws.send(JSON.stringify({ type: 'voice_join', sender: username }));
                voiceUsers.push(username);
                updateVoiceUsers();
            } else {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(t => t.stop());
                inVoice = false;
                document.getElementById('joinVoiceBtn').textContent = 'üé§ Join Voice';
                document.getElementById('joinVoiceBtn').classList.remove('active');
                document.getElementById('muteBtn').style.display = 'none';
                ws.send(JSON.stringify({ type: 'voice_leave', sender: username }));
                voiceUsers = voiceUsers.filter(u => u !== username);
                updateVoiceUsers();
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('muteBtn').textContent = isMuted ? 'üîá Unmute' : 'üîä Mute';
        }

        async function toggleScreen() {
            if (!isScreenSharing) {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { width: 1280, height: 720, frameRate: 5 } 
                });
                isScreenSharing = true;
                document.getElementById('screenBtn').textContent = 'üõë Stop Sharing';
                document.getElementById('screenBtn').classList.add('active');
                ws.send(JSON.stringify({ type: 'screen_start', sender: username }));
                screenUsers.push(username);
                updateScreenUsers();

                const video = document.createElement('video');
                video.srcObject = screenStream;
                video.autoplay = true;
                const canvas = document.createElement('canvas');
                canvas.width = 1280;
                canvas.height = 720;
                const ctx = canvas.getContext('2d');

                const sendFrame = () => {
                    if (!isScreenSharing) return;
                    ctx.drawImage(video, 0, 0, 1280, 720);
                    const frame = canvas.toDataURL('image/jpeg', 0.5);
                    ws.send(JSON.stringify({ type: 'screen_frame', sender: username, content: frame }));
                    setTimeout(sendFrame, 200);
                };
                video.onloadeddata = sendFrame;
                screenStream.getVideoTracks()[0].onended = toggleScreen;
            } else {
                screenStream.getTracks().forEach(t => t.stop());
                isScreenSharing = false;
                document.getElementById('screenBtn').textContent = 'üñ•Ô∏è Share Screen';
                document.getElementById('screenBtn').classList.remove('active');
                ws.send(JSON.stringify({ type: 'screen_stop', sender: username }));
                screenUsers = screenUsers.filter(u => u !== username);
                updateScreenUsers();
            }
        }

        function updateVoiceUsers() {
            const div = document.getElementById('voiceUsers');
            document.getElementById('voiceCount').textContent = voiceUsers.length;
            if (voiceUsers.length === 0) {
                div.innerHTML = '<div style="color:#888;font-size:12px;">No one in voice</div>';
            } else {
                div.innerHTML = voiceUsers.map(u => `
                    <div class="voice-user" id="voice-${u}">
                        <span>${u}</span>
                        <div class="volume-indicator" id="vol-${u}"></div>
                    </div>
                `).join('');
            }
        }

        function updateScreenUsers() {
            const div = document.getElementById('screenShares');
            if (screenUsers.length === 0) {
                div.innerHTML = '<div style="color:#888;font-size:12px;">No screen shares</div>';
            } else {
                div.innerHTML = screenUsers.map(u => `
                    <div class="screen-share-item" onclick="viewScreen('${u}')">${u}'s screen</div>
                `).join('');
            }
        }

        async function playAudio(sender, base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            const blob = new Blob([bytes], { type: 'audio/webm;codecs=opus' });
            const audio = new Audio(URL.createObjectURL(blob));
            audio.onplay = () => {
                const ind = document.getElementById(`vol-${sender}`);
                if (ind) {
                    ind.classList.add('active');
                    const userDiv = document.getElementById(`voice-${sender}`);
                    if (userDiv) userDiv.classList.add('speaking');
                }
            };
            audio.onended = () => {
                const ind = document.getElementById(`vol-${sender}`);
                if (ind) {
                    ind.classList.remove('active');
                    const userDiv = document.getElementById(`voice-${sender}`);
                    if (userDiv) userDiv.classList.remove('speaking');
                }
                URL.revokeObjectURL(audio.src);
            };
            await audio.play();
        }

        function handleScreenFrame(sender, frame) {
            if (!window.screenFrames) window.screenFrames = {};
            window.screenFrames[sender] = frame;
            const modal = document.getElementById('screenModal');
            const header = document.getElementById('screenModalHeader');
            if (modal.classList.contains('active') && header.textContent === `${sender}'s Screen`) {
                document.getElementById('screenImage').src = frame;
            }
        }

        function viewScreen(user) {
            document.getElementById('screenModalHeader').textContent = `${user}'s Screen`;
            document.getElementById('screenModal').classList.add('active');
            if (window.screenFrames && window.screenFrames[user]) {
                document.getElementById('screenImage').src = window.screenFrames[user];
            }
        }

        function closeScreenModal() {
            document.getElementById('screenModal').classList.remove('active');
        }

        function showGuildModal() {
            document.getElementById('guildModal').classList.add('active');
        }

        function closeGuildModal() {
            document.getElementById('guildModal').classList.remove('active');
        }

        function createGuild() {
            const name = document.getElementById('guildNameInput').value.trim();
            if (!name) return alert('Enter guild name');
            ws.send(JSON.stringify({ type: 'create_guild', name }));
        }

        function joinGuild() {
            const code = document.getElementById('inviteCodeInput').value.trim().toUpperCase();
            if (!code) return alert('Enter invite code');
            ws.send(JSON.stringify({ type: 'join_guild', invite_code: code }));
        }

        function copyInvite() {
            if (!currentGuild) return;
            navigator.clipboard.writeText(currentGuild.invite_code);
            alert('Invite code copied!');
        }
    </script>
</body>
</html>
